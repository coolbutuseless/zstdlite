---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)

library(dplyr)
library(zstdlite)


if (FALSE) {
  covr::report(covr::package_coverage(
    line_exclusions = list('src/zstd.c', 'src/zstd.h')
  ))
}

if (FALSE) {
  pkgdown::build_site(override = list(destination = "../coolbutuseless.github.io/package/yyjsonr"))
}
```

# zstdlite

<!-- badges: start -->
![](https://img.shields.io/badge/cool-useless-green.svg)
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![R-CMD-check](https://github.com/coolbutuseless/zstdlite/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/coolbutuseless/zstdlite/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

`zstdlite` provides access to the very fast (and highly configurable) 
 [zstd](https://github.com/facebook/zstd) library for performing in-memory compression of 
R objects.


[zstd](https://github.com/facebook/zstd) code provided with this package is v1.5.5.

# ToDo before release

* zstd_compress/zstd_decompess() to file should use a streaming interface
* Debug/test compression/decompression with dictionaries


## What's in the box

* `zstd_serialize()` and `zstd_unserialize()` for converting R objects to/from
  a compressed representation

## Installation

You can install from [GitHub](https://github.com/coolbutuseless/zstdlite) with:

``` r
# install.package('remotes')
remotes::install_github('coolbutuseless/zstdlite')
```

## Basic Usage

```{r}
lobstr::obj_size(mtcars)

buf <- zstd_serialize(mtcars)
length(buf) # Number of compressed bytes

# compression ratio
length(buf)/as.numeric(lobstr::obj_size(mtcars))

zstd_unserialize(buf) |> head()
```


## Simple Benchmark

```{r}
dat <- iris[sample(nrow(iris), 100000, TRUE),]
lobstr::obj_size(dat)

file <- tempfile()
res <- bench::mark(
  zstd_serialize(dat, file = file),
  zstd_serialize(dat, file = file, level = -5, num_threads = 3),
  saveRDS(dat, file = file)
)

res[,1:5]
```

```{r echo=FALSE}
library(ggplot2)
library(dplyr)
plot_df <- res %>%
  mutate(run = as.character(expression)) %>%
  mutate(speedup = `itr/sec` / min(`itr/sec`))

ggplot(plot_df) +
  geom_col(aes(run, speedup)) + 
  theme_bw() + 
  labs(
    title = "Saving `zstd` compressed R objects",
    subtitle = "Bigger is better",
    x = NULL,
    y = "Factor speed increase over saveRDS()"
  )
```





### Zstd "Single File" Libary

* To simplify the code within this package, it uses the 'single file library' version of zstd
* To update this package when zstd is updated, create the single file library version
    1. cd zstd/build/single_file_libs
    2. sh create_single_file_library.sh
    3. Wait.....
    4. copy zstd/built/single_file_libs/zstd.c into zstdlite/src
    5. copy zstd/lib/zstd.h into zstdlite/src

## Related Software


For a more general solution to fast serialization of R objects, see the 
[fst](https://github.com/fstpackage/fst) or [qs](https://cran.r-project.org/package=qs) packages.

* [lz4](https://github.com/lz4/lz4) and [zstd](https://github.com/facebook/zstd) - both by Yann Collet
* [fst](https://github.com/fstpackage/fst) for serialisation of data.frames using
  lz4 and zstd
* [qs](https://cran.r-project.org/package=qs) for fast serialization of arbitrary R objects
  with lz4 and zstd

## Acknowledgements

* Yann Collett for releasing, maintaining and advancing 
[lz4](https://github.com/lz4/lz4) and [zstd](https://github.com/facebook/zstd)
* R Core for developing and maintaining such a wonderful language.
* CRAN maintainers, for patiently shepherding packages onto CRAN and maintaining
  the repository
